<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamGuard Smart Dashboard</title>

    <!-- Alpine.js (Core) -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- App Logic -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('dashboard', () => ({
                activeTab: 'logs',
                logs: [],
                keyUsage: [], // New stats
                filter: {
                    enabled: true,
                    securityRules: '',
                    minConfidence: 60
                },
                settings: {
                    openRouterKeys: '',
                    // aiProvider: 'openrouter', // Fixed
                    telegramToken: '',
                    telegramChatId: '',
                    telegramAdminId: '',
                    dailyQuota: 50,
                    aiEnabled: true // New toggle
                },
                pollInterval: null,
                zones: {},
                activeZoneCamera: '', // Was 'Camera 01'
                zonePoints: [], // [[x,y],...] normalized
                zoneImage: '/latest.jpg?t=' + Date.now(), // Default to latest snapshot with cache bust

                async init() {
                    console.log('StreamGuard Dashboard Initialized');

                    // Check if latest.jpg exists/accessible
                    try {
                        const res = await fetch(this.zoneImage, { method: 'HEAD' });
                        if (!res.ok) this.zoneImage = null;
                    } catch (e) { this.zoneImage = null; }

                    // Start log polling
                    this.fetchLogs();
                    this.pollInterval = setInterval(() => {
                        if (this.activeTab === 'logs') this.fetchLogs();
                        if (this.activeTab === 'filter') this.loadKeyUsage();
                    }, 3000);

                    // Load config
                    this.loadFilter();
                    this.loadSettings();
                    this.loadKeyUsage();
                    this.loadZones();
                },

                async loadZones() {
                    try {
                        const res = await fetch('/api/zones');
                        if (res.ok) {
                            this.zones = await res.json();
                            // Auto-select first saved camera if current default is not found
                            const keys = Object.keys(this.zones);
                            if (keys.length > 0 && !keys.includes(this.activeZoneCamera)) {
                                this.activeZoneCamera = keys[0];
                            }
                            this.updateZoneCanvas();
                            this.updateActiveZonePoints(); // Sync on load
                        }
                    } catch (e) { console.error('Load zones error:', e); }
                },

                async saveZones() {
                    try {
                        this.zones[this.activeZoneCamera] = this.zonePoints;
                        await fetch('/api/zones', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.zones)
                        });
                        alert('Zone saved for ' + this.activeZoneCamera);
                    } catch (e) { alert('Error saving zones'); }
                },

                addZonePoint(e) {
                    const rect = e.target.getBoundingClientRect();
                    const x = (e.clientX - rect.left) / rect.width;
                    const y = (e.clientY - rect.top) / rect.height;

                    // Force reactivity by reassigning array
                    this.zonePoints = [...this.zonePoints, [x, y]];
                    console.log('Added Point:', x, y, 'Total:', this.zonePoints.length);
                },

                resetZone() {
                    this.zonePoints = [];
                    this.updateZoneCanvas();
                },

                updateZoneCanvas() {
                    // Logic to redraw canvas lines
                    // Note: Alpine reactive re-render might handle SVG better
                },

                async fetchLogs() {
                    try {
                        const res = await fetch('/api/logs');
                        if (res.ok) this.logs = await res.json();
                    } catch (e) { console.error('Log fetch error:', e); }
                },

                async clearLogs() {
                    try {
                        await fetch('/api/logs/clear', { method: 'POST' });
                        this.logs = [];
                    } catch (e) { console.error('Clear log error:', e); }
                },

                async loadFilter() {
                    try {
                        const res = await fetch('/api/filter');
                        if (res.ok) this.filter = await res.json();
                    } catch (e) { console.error('Load filter error:', e); }
                },

                async loadKeyUsage() {
                    try {
                        const res = await fetch('/api/key-usage');
                        if (res.ok) this.keyUsage = await res.json();
                    } catch (e) { console.error('Load key usage error:', e); }
                },

                async resetUsage() {
                    if (!confirm('Reset all key usage quotas to 0?')) return;
                    try {
                        await fetch('/api/key-usage/reset', { method: 'POST' });
                        this.loadKeyUsage();
                        alert('Quotas reset!');
                    } catch (e) { alert('Error: ' + e); }
                },

                async saveFilter() {
                    try {
                        await fetch('/api/filter', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.filter)
                        });
                        console.log('Filter saved');
                    } catch (e) { console.error('Save filter error:', e); }
                },

                async loadSettings() {
                    try {
                        const res = await fetch('/api/settings');
                        if (res.ok) this.settings = await res.json();
                    } catch (e) { console.error('Load settings error:', e); }
                },

                async saveSettings() {
                    if (!confirm('Save settings to .env file? Server will restart.')) return;
                    try {
                        await fetch('/api/settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.settings)
                        });
                        alert('Settings saved! Server restarting...');
                    } catch (e) {
                        alert('Error saving settings: ' + e.message);
                    }
                },

                // Watch for camera changes to load existing points
                updateActiveZonePoints() {
                    if (this.zones[this.activeZoneCamera]) {
                        // Clone to avoid reference issues
                        this.zonePoints = JSON.parse(JSON.stringify(this.zones[this.activeZoneCamera]));
                    } else {
                        this.zonePoints = [];
                    }
                },

                async testTelegram() {
                    try {
                        const res = await fetch('/api/test-telegram', { method: 'POST' });
                        const data = await res.json();
                        if (data.success) alert('Test message sent!');
                        else alert('Failed: ' + data.error);
                    } catch (e) {
                        alert('Error: ' + e.message);
                    }
                },

                async testAdmin() {
                    try {
                        const res = await fetch('/api/test-admin', { method: 'POST' });
                        const data = await res.json();
                        if (data.success) alert('Admin Alert sent!');
                        else alert('Failed: ' + data.error);
                    } catch (e) {
                        alert('Error: ' + e.message);
                    }
                }
            }));
        });
    </script>

    <style>
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        [x-cloak] {
            display: none !important;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }

        .animate-scaleIn {
            animation: scaleIn 0.2s ease-out;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen font-sans antialiased" x-data="dashboard" x-cloak>

    <!-- Navbar -->
    <nav class="bg-gray-800 border-b border-gray-700 fixed w-full top-0 z-50 shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üõ°Ô∏è</span>
                    <span class="font-bold text-xl tracking-tight text-blue-400">StreamGuard AI</span>
                </div>
                <div class="flex space-x-2 md:space-x-4">
                    <button @click="activeTab = 'logs'"
                        :class="activeTab === 'logs' ? 'bg-blue-600 text-white shadow-lg' : 'text-gray-300 hover:bg-gray-700 hover:text-white'"
                        class="px-3 py-2 rounded-md text-sm font-bold transition-all duration-200">
                        Activity Logs
                    </button>
                    <button @click="activeTab = 'filter'"
                        :class="activeTab === 'filter' ? 'bg-blue-600 text-white shadow-lg' : 'text-gray-300 hover:bg-gray-700 hover:text-white'"
                        class="px-3 py-2 rounded-md text-sm font-bold transition-all duration-200">
                        Smart Agent
                    </button>
                    <button @click="activeTab = 'settings'"
                        :class="activeTab === 'settings' ? 'bg-blue-600 text-white shadow-lg' : 'text-gray-300 hover:bg-gray-700 hover:text-white'"
                        class="px-3 py-2 rounded-md text-sm font-bold transition-all duration-200">
                        Settings
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-24 pb-10 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">

        <!-- Logs Tab -->
        <div x-show="activeTab === 'logs'" x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0"
            class="space-y-4">

            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold flex items-center gap-2 text-green-400">
                    <span class="relative flex h-3 w-3">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                    </span>
                    Live Activity
                </h2>
                <button @click="clearLogs"
                    class="text-xs bg-gray-800 hover:bg-red-900 border border-gray-600 hover:border-red-500 px-3 py-1 rounded text-gray-300 transition-colors">
                    Clear Logs
                </button>
            </div>

            <div class="bg-gray-950 rounded-xl shadow-2xl border border-gray-800 h-[600px] flex flex-col relative">
                <!-- Log Container -->
                <div class="flex-1 overflow-y-auto p-4 space-y-2 font-mono text-sm" id="logs-container">
                    <template x-for="(log, index) in logs" :key="index">
                        <div class="border-l-2 pl-3 py-2 animate-fadeIn group" :class="{
                                'border-red-500 bg-red-900/10': log.type === 'alert',
                                'border-green-500': log.type === 'success',
                                'border-blue-500': log.type === 'info' || log.type === 'processing',
                                'border-orange-500': log.type === 'error'
                            }">
                            <div class="flex items-start gap-2">
                                <span class="text-xs text-gray-500 font-mono whitespace-nowrap pt-0.5"
                                    x-text="'['+log.timestamp+']'"></span>
                                <div class="flex-1">
                                    <div x-text="log.message" class="text-gray-300 break-words"
                                        :class="{'font-bold text-red-400': log.type==='alert', 'text-green-400': log.type==='success'}">
                                    </div>

                                    <!-- Log Image -->
                                    <template x-if="log.image">
                                        <div class="mt-2">
                                            <img :src="log.image"
                                                class="h-32 rounded border border-gray-700 cursor-zoom-in hover:brightness-110 transition object-cover"
                                                @click="$dispatch('open-image', log.image)" title="View snapshot">
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Image Modal -->
                    <div x-data="{ open: false, src: '' }" @open-image.window="open = true; src = $event.detail"
                        x-show="open" x-transition.opacity
                        class="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 cursor-zoom-out"
                        @click="open = false" x-cloak>
                        <img :src="src" class="max-w-[95%] max-h-[95%] rounded shadow-2xl animate-scaleIn">
                    </div>
                    <div x-show="logs.length === 0"
                        class="absolute inset-0 flex items-center justify-center text-gray-600 italic">
                        No activity yet. Monitoring...
                    </div>
                </div>
            </div>
        </div>

        <!-- Zones Tab -->
        <div x-show="activeTab === 'zones'" class="space-y-6">
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h2 class="text-2xl font-bold mb-4 text-purple-400">üìê Security Zones</h2>

                <div class="mb-4 flex gap-4">
                    <input type="text" x-model="activeZoneCamera"
                        class="bg-gray-900 border border-gray-600 rounded px-3 py-2 text-white"
                        placeholder="Camera Name (e.g. Camera 01)">
                    <button @click="saveZones"
                        class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded font-bold text-white">Save
                        Zone</button>
                    <button @click="resetZone" class="bg-red-900 hover:bg-red-800 px-4 py-2 rounded text-red-200">Reset
                        Points</button>
                </div>

                <p class="text-sm text-gray-400 mb-4">Click on the image to define the polygon vertices. The last point
                    connects to the first.</p>

                <div class="relative inline-block border-2 border-purple-500/50 rounded overflow-hidden">
                    <!-- Background Image (Latest Log) -->
                    <template x-if="logs.length > 0 && logs[0].image">
                        <div class="relative">
                            <img :src="logs[0].image" class="max-w-[800px] w-full block">

                            <!-- SVG Overlay for Drawing -->
                            <svg class="absolute inset-0 w-full h-full cursor-crosshair" @click="addZonePoint">
                                <!-- Existing Saved Zone -->
                                <template x-if="zones[activeZoneCamera]">
                                    <polygon
                                        :points="zones[activeZoneCamera].map(p => p[0]*100 + '%,' + p[1]*100 + '%').join(' ')"
                                        class="fill-green-500/20 stroke-green-500 stroke-2" />
                                </template>

                                <!-- Current Drawing Zone -->
                                <polygon :points="zonePoints.map(p => p[0]*100 + '%,' + p[1]*100 + '%').join(' ')"
                                    class="fill-purple-500/30 stroke-purple-400 stroke-2" />

                                <!-- Points -->
                                <template x-for="(p, i) in zonePoints">
                                    <circle :cx="p[0]*100 + '%'" :cy="p[1]*100 + '%'" r="4"
                                        class="fill-white stroke-purple-600" />
                                </template>
                            </svg>
                        </div>
                    </template>
                    <div x-show="logs.length === 0"
                        class="h-64 w-full bg-gray-900 flex items-center justify-center text-gray-500">
                        Waiting for camera event to setup zone...
                    </div>
                </div>
            </div>
        </div>

        <!-- Smart Agent Tab -->
        <div x-show="activeTab === 'filter'" x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0"
            class="space-y-6">

            <div class="bg-gray-800 p-6 md:p-8 rounded-xl shadow-2xl border border-gray-700">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-3 text-blue-400 border-b border-gray-700 pb-4">
                    <span>ü§ñ</span> Smart Security Agent
                </h2>

                <!-- API Usage Stats Removed -->

                <div class="mb-8 flex items-center bg-gray-900/50 p-4 rounded-lg border border-gray-700/50">
                    <label class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" x-model="filter.enabled" class="sr-only" @change="saveFilter">
                            <div class="block bg-gray-600 w-14 h-8 rounded-full transition-colors"
                                :class="filter.enabled ? 'bg-green-600' : 'bg-gray-600'"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-transform duration-200"
                                :class="filter.enabled ? 'transform translate-x-6' : ''"></div>
                        </div>
                        <div class="ml-4">
                            <div class="text-gray-200 font-bold text-lg">Enable AI Agent</div>
                            <div class="text-gray-500 text-sm">Turn AI monitoring on/off</div>
                        </div>
                    </label>
                </div>

                <!-- Rule Context (HIDDEN - YOLO doesn't use this field) -->
                <div class="mb-8" x-show="false">
                    <label class="block text-base font-bold text-blue-300 mb-2">
                        Security Context & Rules (Ng·ªØ c·∫£nh gi√°m s√°t)
                    </label>
                    <p class="text-sm text-gray-400 mb-3">
                        M√¥ t·∫£ cho AI bi·∫øt b·∫°n mu·ªën c·∫£nh b√°o ƒëi·ªÅu g√¨.
                    </p>
                    <textarea x-model="filter.securityRules" rows="6"
                        class="w-full bg-gray-900 border border-gray-600 rounded-lg py-3 px-4 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all placeholder-gray-600"
                        placeholder="V√≠ d·ª•: C·∫£nh b√°o khi c√≥ ng∆∞·ªùi l·∫° tr∆∞·ªõc c·ªïng. B·ªè qua xe ch·∫°y ngang qua ƒë∆∞·ªùng."
                        @change="saveFilter"></textarea>
                </div>

                <!-- Confidence Slider -->
                <div class="mb-4 bg-gray-900/50 p-6 rounded-xl border border-gray-700/50">
                    <div class="flex justify-between mb-4">
                        <label class="block text-base font-medium text-gray-300">
                            Minimum Confidence (ƒê·ªô tin c·∫≠y)
                        </label>
                        <span class="text-blue-400 font-bold text-lg" x-text="filter.minConfidence + '%'"></span>
                    </div>

                    <input type="range" min="0" max="100" x-model="filter.minConfidence"
                        class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500 hover:accent-blue-400 transition-all"
                        @change="saveFilter">
                    <div class="flex justify-between mt-2 text-xs text-gray-500">
                        <span>Sensitive (0%)</span>
                        <span>Balanced (50%)</span>
                        <span>Strict (100%)</span>
                    </div>
                </div>
                <!-- Zone Editor Section (Merged) -->
                <div class="mb-4 bg-gray-900/50 p-6 rounded-xl border border-gray-700/50">
                    <h2 class="text-xl font-bold mb-4 text-purple-400 flex items-center gap-2">
                        <span>üìê</span> Security Zones (V√πng gi√°m s√°t)
                    </h2>

                    <div class="mb-4 flex flex-wrap gap-4 items-center">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-xs text-gray-500 mb-1">Camera Name (Must match Email
                                Subject)</label>
                            <div class="flex gap-2">
                                <input type="text" x-model="activeZoneCamera"
                                    class="flex-1 bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm"
                                    placeholder="e.g. Camera 01">
                                <select x-show="Object.keys(zones).length > 0"
                                    @change="activeZoneCamera = $event.target.value; updateActiveZonePoints()"
                                    class="bg-gray-800 border border-gray-600 rounded px-2 text-white text-sm max-w-[100px]">
                                    <option value="" disabled selected>Select...</option>
                                    <template x-for="name in Object.keys(zones)" :key="name">
                                        <option :value="name" x-text="name" :selected="name === activeZoneCamera">
                                        </option>
                                    </template>
                                </select>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-4 sm:mt-0">
                            <button @click="saveZones"
                                class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded font-bold text-white text-sm">Save
                                Zone</button>
                            <button @click="resetZone"
                                class="bg-red-900 hover:bg-red-800 px-4 py-2 rounded text-red-200 text-sm">Reset</button>
                        </div>
                    </div>

                    <!-- Dynamic Logic Settings -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-black/30 p-3 rounded border border-gray-700">
                            <label class="block text-xs font-bold text-gray-400 mb-1">Person Stationary IOU
                                (<span x-text="(filter.personIouThreshold * 100).toFixed(0) + '%'"></span>)
                            </label>
                            <input type="range" x-model.number="filter.personIouThreshold" min="0.1" max="1.0"
                                step="0.05"
                                class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-blue-500"
                                @change="saveFilter">
                            <p class="text-[10px] text-gray-500 mt-1">Lower = More Sensitive to people standing still.
                            </p>
                        </div>
                        <div class="bg-black/30 p-3 rounded border border-gray-700">
                            <label class="block text-xs font-bold text-gray-400 mb-1">Vehicle Stationary IOU
                                (<span x-text="(filter.vehicleIouThreshold * 100).toFixed(0) + '%'"></span>)
                            </label>
                            <input type="range" x-model.number="filter.vehicleIouThreshold" min="0.1" max="1.0"
                                step="0.05"
                                class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-orange-500"
                                @change="saveFilter">
                            <p class="text-[10px] text-gray-500 mt-1">Higher = Strict (Only parked cars).</p>
                        </div>
                        <div class="bg-black/30 p-3 rounded border border-gray-700 flex items-center justify-between">
                            <div>
                                <label class="block text-xs font-bold text-gray-400">Ignore Moving People</label>
                                <p class="text-[10px] text-gray-500">If ON, moving people are ignored.</p>
                            </div>
                            <input type="checkbox" x-model="filter.ignoreMovingPersons"
                                class="w-5 h-5 accent-purple-500" @change="saveFilter">
                        </div>
                    </div>

                    <p class="text-xs text-center text-green-400 mb-2" x-text="'Points recorded: ' + zonePoints.length">
                    </p>

                    <div
                        class="relative inline-block w-full border-2 border-purple-500/30 rounded-lg overflow-hidden bg-black/50 min-h-[300px]">
                        <!-- Background Image (Latest Log or Saved Snapshot) -->
                        <template x-if="(logs.length > 0 && logs[0].image) || zoneImage">
                            <div class="relative w-full h-full cursor-crosshair" @click="addZonePoint">
                                <img :src="(logs.length > 0 && logs[0].image) ? logs[0].image : zoneImage"
                                    class="w-full object-contain max-h-[600px] pointer-events-none">

                                <!-- SVG Overlay for Drawing -->
                                <!-- FIX: Use viewBox="0 0 100 100" and remove % from points -->
                                <svg class="absolute inset-0 w-full h-full pointer-events-none" style="z-index: 50;"
                                    viewBox="0 0 100 100" preserveAspectRatio="none">

                                    <!-- Existing Saved Zone -->
                                    <template x-if="zones[activeZoneCamera]">
                                        <polygon
                                            :points="zones[activeZoneCamera].map(p => (p[0]*100) + ',' + (p[1]*100)).join(' ')"
                                            class="fill-green-500/20 stroke-green-500 stroke-[0.5]" />
                                    </template>

                                    <!-- Current Drawing Zone -->
                                    <polygon :points="zonePoints.map(p => (p[0]*100) + ',' + (p[1]*100)).join(' ')"
                                        class="fill-purple-500/30 stroke-purple-400 stroke-[0.5]" />

                                    <!-- Points -->
                                    <template x-for="(p, i) in zonePoints">
                                        <circle :cx="p[0]*100" :cy="p[1]*100" r="1.5"
                                            class="fill-white stroke-purple-600 stroke-[0.5]" />
                                    </template>
                                </svg>
                            </div>
                        </template>
                        <div x-show="logs.length === 0 && !zoneImage"
                            class="absolute inset-0 flex flex-col items-center justify-center text-gray-500 p-8 text-center">
                            <span class="text-4xl mb-2">üì∑</span>
                            <p>Waiting for camera activity...</p>
                            <p class="text-xs mt-2">Trigger a motion event to capture an image for zone setup.</p>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 text-center">Click on image to draw points. Zone saves per
                        Camera Name.</p>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div x-show="activeTab === 'settings'" x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0"
            class="space-y-6">

            <div class="bg-gray-800 p-6 md:p-8 rounded-xl shadow-2xl border border-gray-700">
                <h2 class="text-2xl font-bold mb-6 text-gray-200 border-b border-gray-700 pb-4">
                    ‚öôÔ∏è System Settings
                </h2>

                <div class="space-y-6">
                    <!-- OpenRouter Removed -->



                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-300 mb-2">Enable AI Analysis</label>
                        <label class="flex items-center cursor-pointer mt-3">
                            <div class="relative">
                                <input type="checkbox" x-model="settings.aiEnabled" class="sr-only">
                                <div class="block bg-gray-600 w-14 h-8 rounded-full transition-colors"
                                    :class="settings.aiEnabled ? 'bg-blue-600' : 'bg-gray-600'"></div>
                                <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-transform duration-200"
                                    :class="settings.aiEnabled ? 'transform translate-x-6' : ''"></div>
                            </div>
                            <div class="ml-3 text-sm text-gray-400">
                                <span x-show="settings.aiEnabled">AI Active (Filter Alerts)</span>
                                <span x-show="!settings.aiEnabled">Direct Forward (All Emails)</span>
                            </div>
                        </label>
                    </div>

                    <div class="border-t border-gray-700 pt-6"></div>

                    <div>
                        <label class="block text-sm font-bold text-gray-300 mb-2">Telegram Bot Token</label>
                        <input type="password" x-model="settings.telegramToken"
                            class="w-full bg-gray-900 border border-gray-600 rounded-lg py-3 px-4 text-gray-200 font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
                            placeholder="123456:ABC-DEF...">
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-300 mb-2">Recipient Chat IDs (Users)</label>
                        <input type="text" x-model="settings.telegramChatId"
                            class="w-full bg-gray-900 border border-gray-600 rounded-lg py-3 px-4 text-gray-200 font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
                            placeholder="12345678, 87654321">
                        <p class="text-xs text-gray-500 mt-2">
                            Ng∆∞·ªùi d√πng nh·∫≠n c·∫£nh b√°o. NgƒÉn c√°ch b·ªüi d·∫•u ph·∫©y (,).
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-yellow-500 mb-2">Admin Chat ID (Technical
                            Alerts)</label>
                        <div class="flex gap-2">
                            <input type="text" x-model="settings.telegramAdminId"
                                class="w-full bg-gray-900 border border-gray-600 rounded-lg py-3 px-4 text-gray-200 font-mono text-sm focus:ring-2 focus:ring-yellow-500 focus:outline-none"
                                placeholder="99999999">
                            <button @click="testAdmin"
                                class="bg-gray-700 hover:bg-gray-600 px-4 rounded text-sm font-bold">Test</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            Admin nh·∫≠n th√¥ng b√°o l·ªói k·ªπ thu·∫≠t v√† c·∫£nh b√°o h·∫øt quota.
                        </p>
                    </div>

                    <div class="pt-8 flex flex-wrap gap-4 border-t border-gray-700 mt-8">
                        <button @click="saveSettings"
                            class="flex-1 bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg flex justify-center items-center gap-2">
                            <span>üíæ</span> Save to .env
                        </button>
                        <button @click="testTelegram"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg flex justify-center items-center gap-2">
                            <span>üì®</span> Test User Alert
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </main>
</body>

</html>